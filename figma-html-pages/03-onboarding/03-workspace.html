<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QULAY CHAT - Workspace Setup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --bg: #f9fafb;
      --white: #ffffff;
      --gray-900: #111827;
      --gray-700: #374151;
      --gray-500: #6b7280;
      --gray-400: #9ca3af;
      --gray-300: #d1d5db;
      --gray-200: #e5e7eb;
      --error: #ef4444;
      --error-bg: #fef2f2;
      --shadow: 0 10px 20px rgba(17, 24, 39, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: var(--bg);
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--gray-900);
      padding: 24px;
    }

    .wrap {
      width: min(100%, 600px);
    }

    .progress {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 700;
    }

    .done,
    .active {
      background: var(--primary);
      color: #fff;
    }

    .next {
      background: var(--gray-300);
      color: var(--gray-400);
    }

    .line {
      width: 48px;
      height: 2px;
      background: var(--gray-300);
    }

    .line.done {
      background: var(--primary);
    }

    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 40px;
      animation: fade-in-up 0.3s ease-out both;
    }

    .step {
      margin: 0 0 10px;
      color: var(--primary);
      font-size: 13px;
      font-weight: 600;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 600;
    }

    .sub {
      margin: 0 0 24px;
      color: var(--gray-500);
      font-size: 14px;
      line-height: 1.5;
    }

    .field {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: var(--gray-700);
      font-size: 14px;
      font-weight: 500;
    }

    .required-star {
      color: var(--error);
    }

    input,
    select {
      width: 100%;
      height: 44px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      padding: 0 16px;
      font-size: 14px;
      outline: none;
      background: #fff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.16);
    }

    input.invalid {
      border-color: var(--error);
      background: var(--error-bg);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.12);
    }

    .help-text {
      margin-top: 6px;
      font-size: 12px;
      color: var(--gray-500);
    }

    .error-text {
      margin-top: 6px;
      font-size: 12px;
      color: var(--error);
      display: none;
    }

    .error-text.show {
      display: block;
    }

    .actions {
      margin-top: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn {
      height: 44px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .ghost {
      border: 1px solid var(--gray-300);
      background: #fff;
      color: var(--gray-700);
    }

    .ghost:hover {
      background: #f3f4f6;
    }

    .primary {
      border: none;
      background: var(--primary);
      color: #fff;
      position: relative;
    }

    .primary:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .primary.loading {
      color: transparent;
    }

    .primary.loading::after {
      content: "";
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      position: absolute;
      left: 50%;
      top: 50%;
      margin-left: -8px;
      margin-top: -8px;
      animation: spin 0.7s linear infinite;
    }

    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 640px) {
      .card {
        padding: 24px 20px;
      }

      .actions {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="progress" role="img" aria-label="Onboarding progress: 2 of 5">
      <div class="dot done">âœ“</div>
      <div class="line done"></div>
      <div class="dot active">2</div>
      <div class="line"></div>
      <div class="dot next">3</div>
      <div class="line"></div>
      <div class="dot next">4</div>
      <div class="line"></div>
      <div class="dot next">5</div>
      <span style="margin-left:8px;color:#6b7280;font-size:14px;">2/5</span>
    </div>

    <main class="card">
      <p class="step">2-qadam / 5</p>
      <h1 id="setup-title">Workspace yaratish</h1>
      <p class="sub">Kompaniyangiz uchun ishchi makonni sozlang.</p>

      <form id="workspace-form" novalidate>
        <div class="field">
          <label for="workspace-name">Workspace nomi <span class="required-star">*</span></label>
          <input id="workspace-name" name="workspace_name" type="text" placeholder="Masalan: TechUz Support" maxlength="64" autocomplete="organization" />
          <p class="help-text" id="workspace-help">Bu nom jamoangizga ko'rinadi.</p>
          <p class="error-text" id="workspace-error">Workspace nomi majburiy maydon.</p>
        </div>

        <div class="field">
          <label for="website-url">Kompaniya veb-sayti</label>
          <input id="website-url" name="website_url" type="url" placeholder="https://kompaniya.uz" inputmode="url" />
        </div>

        <div class="field">
          <label for="team-size">Jamoa hajmi</label>
          <select id="team-size" name="team_size">
            <option value="1-5">1-5</option>
            <option value="6-20">6-20</option>
            <option value="21-50">21-50</option>
            <option value="51+">51+</option>
          </select>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost" id="skip-btn">Orqaga</button>
          <button type="submit" class="btn primary" id="continue-btn" disabled>Davom etish</button>
        </div>
      </form>
    </main>
  </div>

  <script>
    var STATE_KEY = "qulaychat_onboarding_state_v1";

    function sendAnalyticsEvent(name, payload) {
      try {
        if (window.dataLayer && Array.isArray(window.dataLayer)) {
          window.dataLayer.push(Object.assign({ event: name }, payload || {}));
        }
      } catch (_) {
        // analytics should not break UI flow
      }
    }

    function parseState() {
      try {
        return JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
      } catch (_) {
        return {};
      }
    }

    function saveState(patch) {
      var current = parseState();
      var next = Object.assign({}, current, patch || {}, { updatedAt: new Date().toISOString() });
      localStorage.setItem(STATE_KEY, JSON.stringify(next));
      return next;
    }

    function normalizeWebsite(value) {
      var trimmed = (value || "").trim();
      if (!trimmed) {
        return "";
      }
      if (/^https?:\/\//i.test(trimmed)) {
        return trimmed;
      }
      return "https://" + trimmed;
    }

    function isWorkspaceNameValid(value) {
      return (value || "").trim().length >= 2;
    }

    document.addEventListener("DOMContentLoaded", function () {
      var state = parseState();
      var params = new URLSearchParams(window.location.search);
      var workspaceInput = document.getElementById("workspace-name");
      var websiteInput = document.getElementById("website-url");
      var teamSelect = document.getElementById("team-size");
      var form = document.getElementById("workspace-form");
      var error = document.getElementById("workspace-error");
      var help = document.getElementById("workspace-help");
      var continueButton = document.getElementById("continue-btn");
      var skipButton = document.getElementById("skip-btn");
      var setupTitle = document.getElementById("setup-title");

      var userName = (params.get("name") || state.userName || "").trim();
      if (userName && setupTitle) {
        setupTitle.textContent = userName + " uchun workspace yaratish";
      }

      if (state.workspaceName) {
        workspaceInput.value = state.workspaceName;
      }
      if (state.websiteUrl) {
        websiteInput.value = state.websiteUrl;
      }
      if (state.teamSize) {
        teamSelect.value = state.teamSize;
      }

      function refreshValidation() {
        var valid = isWorkspaceNameValid(workspaceInput.value);
        continueButton.disabled = !valid;

        if (valid) {
          workspaceInput.classList.remove("invalid");
          error.classList.remove("show");
          help.style.display = "block";
          return true;
        }
        return false;
      }

      workspaceInput.addEventListener("input", refreshValidation);
      refreshValidation();

      skipButton.addEventListener("click", function () {
        saveState({
          status: "skipped",
          skippedAt: new Date().toISOString(),
          currentStep: 1,
          currentPage: "01-welcome.html"
        });
        sendAnalyticsEvent("onboarding_workspace_back", { step: 2, to: "./01-welcome.html" });
        window.location.href = "./01-welcome.html";
      });

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        var valid = refreshValidation();
        if (!valid) {
          workspaceInput.classList.add("invalid");
          error.classList.add("show");
          help.style.display = "none";
          workspaceInput.focus();
          return;
        }

        var payload = {
          status: "in_progress",
          currentStep: 3,
          currentPage: "04-widget-customize.html",
          userName: userName || state.userName || "Ulug'bek",
          workspaceName: workspaceInput.value.trim(),
          websiteUrl: normalizeWebsite(websiteInput.value),
          teamSize: teamSelect.value
        };
        saveState(payload);

        continueButton.disabled = true;
        continueButton.classList.add("loading");
        sendAnalyticsEvent("onboarding_workspace_continue", {
          step: 2,
          to: "./04-widget-customize.html",
          team_size: teamSelect.value
        });

        setTimeout(function () {
          var next = "./04-widget-customize.html";
          var query = "?name=" + encodeURIComponent(payload.userName);
          window.location.href = next + query;
        }, 220);
      });
    });
  </script>
</body>
</html>
